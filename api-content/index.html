{"posts":[{"title":"PVE上安装jellyfin并实现硬解（on LXC）","content":"V0.1 2021.04.05 基于 intel CPU的软路由(集显HD610)，PVE 6.3-3，jellyfin 10.7.1 此文作为自己折腾的备份记录，主要是方便自己重新折腾。使用LXC容器配置jellyfin服务供家庭娱乐使用，并没有采用常规的docker方案。主要是docker的配置弄起来还是略微麻烦，我目前只需要用jellyfin。 首先按常规操作配置一个LXC容器，目前PVE中自带的容器以ubuntu 20.04版本操作起来较为方便，我自己也使用的这个&quot;ubuntu-20.04-standard_20.04-1_amd64.tar.gz&quot;。 一、配置LXC容器 1.新建一个LXC容器 由于需要访问宿主机的集成显卡以及挂载NFS，配置一个特权容器(创建时将“无特权的容器”前面的勾去掉)。 由于我暂时未使用docker，此设置是否有影响建议自行确认，根据参考文章使用docker需要无特权的容器，但和评论有出入。 OS:ubuntu 20.04 磁盘：10G local-lvm(默认) CPU:4核 默认权重 内存:2G 交换分区：512M(默认) 手动设置IPv4地址 IPV4/CIDR: 设置的内网IP地址/24 （后面的&quot;/24&quot;必须跟上） 网关：路由器地址 配置完成后在容器设置的选项处，点击签名，将NFS勾上。 注：我是使用的OMV作为存储，在LXC容器中通过挂载OMV分享的NFS来进行访问，可根据需要自行判断自己是否需要执行此操作。 2.优化容器系统设置 容器配置完成后启动容器，由于默认禁止ROOT用户SSH访问，需修改“/etc/ssh/sshd_config”文件以便于后续操作。 nano /etc/ssh/sshd_config nano是一个比vim简单方便的命令行文本编辑器，打开文件后找到“PermitRootLogin”行，将前方的注释“#”去掉，按以下修改即可。或可另起一行，按以下输入即可。 PermitRootLogin yes 完成后“ctrl+o”保存文件，“ctrl+x”退出 然后“reboot”重启后使用SSH软件连接（例如finalssh），操作上更为便利。 使用以下命令更改系统自带软件源为第三方源,或采取其他方式也可。 nano /etc/apt/sources.list 将文本中的内容替换为以下内容即可（以下内容仅适用于Ubuntu 20.04或衍生发行版，内容来源：清华大学开源软件镜像站） # 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释 deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse 完成后输入命令更新软件 apt update &amp;&amp; apt dist-upgrade 到目前为止，容器的安装和调整就算基本完成了。 二、jellyfin的安装 根据官网操作，逐行输入以下命令执行安装即可 sudo apt install apt-transport-https wget -O - https://repo.jellyfin.org/jellyfin_team.gpg.key | sudo apt-key add - echo &quot;deb [arch=$( dpkg --print-architecture )] https://repo.jellyfin.org/$( awk -F'=' '/^ID=/{ print $NF }' /etc/os-release ) $( awk -F'=' '/^VERSION_CODENAME=/{ print $NF }' /etc/os-release ) main&quot; | sudo tee /etc/apt/sources.list.d/jellyfin.list sudo apt update sudo apt install jellyfin 安装完成后执行命令 service jellyfin status 在输出中可见“Active: active(running) &quot;字样，说明安装运行成功。 后续可在浏览器中访问”IP地址:8096&quot;即可完成jellyfin的后续设置。 由于此时还未完成硬解的配置和NFS的挂载，可简单设置登录密码和语言等常规设置即可，硬解及媒体库设置可待后续设置完成后再进行操作。 三、硬解的配置 这里需要注意一点，配置硬解时，显卡不能被直通。 补充：关闭显卡直通，编辑/etc/default/grub文件，将GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet video=efifb:off intel_iommu=on&quot; 中的“video=efifb:off ”删掉后 update-grub 以下操作在PVE上进行，保持容器处于关闭状态 可先使用 PVE-TOOLS脚本 （这是一个为proxmox ve写的工具脚本（理论上debian9+可以用）。包括配置邮件，samba，NFS，zfs，嵌套虚拟化，docker，硬盘直通等功能）对PVE的调整和优化。 主要建议执行以下操作：1、更换软件源；2、配置CPU省电；其余看自己需求。 完成后执行以下操作 apt-get update apt-get install -y intel-media-va-driver-non-free &amp;&amp; i965-va-driver-shaders &amp;&amp; vainfo *部分教程使用的是“i965-va-driver”驱动，具体来说主要是开源/不开源以及intel的GPU代数有一定关系。*目前来说，较新的Intel GPU主要使用的应该是 intel-media-va-driver-non-free 和 i965-va-driver-shaders 这两个闭源驱动。 安装完成后输入以下命令 vainfo 正常情况下会得到的输出如下(完整版见后续内容) ...... VAProfileVC1Simple : VAEntrypointVLD VAProfileVC1Main : VAEntrypointVLD ...... VAProfileHEVCMain10 : VAEntrypointVLD VAProfileVP9Profile0 : VAEntrypointVLD VAProfileVP9Profile2 : VAEntrypointVLD 若显示有误请检查是否已经配置直通导致PVE不能使用GPU。调整成功后，执行以下命令： ls -l /etc/dri 正常情况下会得到如下的输出 root@PVE:~# ls -l /dev/dri/ total 0 drwxr-xr-x 2 root root 80 Apr 5 16:56 by-path crw-rw---- 1 root video 226, 0 Apr 5 16:56 card0 crwxrwxrwx 1 root render 226, 128 Apr 5 16:56 renderD128 其中的 renderD128 就是我们需要在LXC容器中使用的显卡，对应的设备号为 226, 128 输入以下命令编辑容器配置，其中 103 需替换成你自己目前的容器ID号，在PVE的节点位置可以看到对应容器或虚拟机的ID号。 nano /etc/pve/lxc/103.conf 然后在文件的最后加入以下内容,其中的 226:128 按你自己的显卡设备号做更改 lxc.cgroup.devices.allow: c 226:128 rwm lxc.mount.entry: /dev/dri/renderD128 dev/dri/renderD128 none bind,optional,create=file **完成后，启动容器。**同时可以核对下修改的 /etc/pve/lxc/103.conf 文件是否有变动，偶尔有发现更改未生效的情况。 以下操作在容器中进行 输入以下命令，检查显卡是否被挂载 ls -l /dev/dri/ 正常情况下会得到以下输出，说明显卡挂载成功 root@Ubuntu:~# ls -l /dev/dri/ total 0 crwxrwxrwx 1 root postfix 226, 128 Apr 5 08:56 renderD128 执行以下操作，获取显卡权限（此操作重要） chmod 777 /dev/dri/* 输入命令更换显卡驱动和检测工具 apt-get install -y intel-media-va-driver-non-free &amp;&amp; i965-va-driver-shaders &amp;&amp; vainfo 执行以下命令检查 vainfo 得到类似如下的输出说明硬解配置成功 root@Ubuntu:~# vainfo error: can't connect to X server! libva info: VA-API version 1.7.0 libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/iHD_drv_video.so libva info: Found init function __vaDriverInit_1_7 libva info: va_openDriver() returns 0 vainfo: VA-API version: 1.7 (libva 2.6.0) vainfo: Driver version: Intel iHD driver for Intel(R) Gen Graphics - 20.1.1 () vainfo: Supported profile and entrypoints VAProfileNone : VAEntrypointVideoProc VAProfileNone : VAEntrypointStats VAProfileMPEG2Simple : VAEntrypointVLD VAProfileMPEG2Simple : VAEntrypointEncSlice VAProfileMPEG2Main : VAEntrypointVLD VAProfileMPEG2Main : VAEntrypointEncSlice VAProfileH264Main : VAEntrypointVLD VAProfileH264Main : VAEntrypointEncSlice VAProfileH264Main : VAEntrypointFEI VAProfileH264Main : VAEntrypointEncSliceLP VAProfileH264High : VAEntrypointVLD VAProfileH264High : VAEntrypointEncSlice VAProfileH264High : VAEntrypointFEI VAProfileH264High : VAEntrypointEncSliceLP VAProfileVC1Simple : VAEntrypointVLD VAProfileVC1Main : VAEntrypointVLD VAProfileVC1Advanced : VAEntrypointVLD VAProfileJPEGBaseline : VAEntrypointVLD VAProfileJPEGBaseline : VAEntrypointEncPicture VAProfileH264ConstrainedBaseline: VAEntrypointVLD VAProfileH264ConstrainedBaseline: VAEntrypointEncSlice VAProfileH264ConstrainedBaseline: VAEntrypointFEI VAProfileH264ConstrainedBaseline: VAEntrypointEncSliceLP VAProfileVP8Version0_3 : VAEntrypointVLD VAProfileVP8Version0_3 : VAEntrypointEncSlice VAProfileHEVCMain : VAEntrypointVLD VAProfileHEVCMain : VAEntrypointEncSlice VAProfileHEVCMain : VAEntrypointFEI VAProfileHEVCMain10 : VAEntrypointVLD VAProfileHEVCMain10 : VAEntrypointEncSlice VAProfileVP9Profile0 : VAEntrypointVLD VAProfileVP9Profile2 : VAEntrypointVLD 这些输出内容就说明了显卡支持的硬解内容，包括 MPEG H264 HEVC(H265) VP9 等。 部分教程使用了其他方式挂载显卡，原理是一致的。 我这里主要是通过了 chmod 手动调整了访问权限，操作上更便捷一点，同时也是很重要的不能遗漏的一步。 四、NFS的挂载 直接在挂载硬盘的可以略过此步，这里也不会详细说明OMV上NFS共享的操作，具体问题请google。 首先安装NFS客户端 sudo apt install nfs-common 检查LXC容器是否有对应NFS共享文件夹的访问权限，其中 192.168.2.10 需更换为你自己共享NFS文件夹的IP地址 showmount –e 192.168.2.10 得到如下输出 Export list for 192.168.2.10: /export 192.168.2.1,192.168.2.2 /export/MOVIE 192.168.2.1 /export/HOME 192.168.2.2 其中就表示了OMV共享的文件夹以及对应的有访问权限的IP地址，根据你自己容器的IP地址选择对应的文件夹或调整OMV的分享设置。 手动挂载文件夹测试，对应的IP地址和共享文件夹、挂载点根据自己情况做相应调整 mount -t nfs 192.168.2.10:/export/HOME /srv/ 然后在jellyfin的媒体库中添加文件夹做测试，如果能正常访问就说明没有问题了。 但是手动挂载的在系统重启之后就会失效，所以我们需要修改 /etc/fstab 来实现自动挂载。 nano /etc/fstab 根据以下调整自己的配置，我为方便使用了系统原有的文件夹，你也可以通过 mkdir 命令手动建立一个挂载用的文件夹。 # &lt;file system&gt; &lt;dir&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt; 192.168.2.10:/export/HOME /srv/ nfs defaults 0 0 重启再测试下jellyfin是否可以正常访问挂载的文件夹，如果成功基本就正常了。 五、硬解的配置 在控制台-播放，按图设置即可，具体项目根据自己需要调整。或者全部选上，播放有问题时再做调整。 部分功能建议关闭 允许以HEVC格式编码，启用VPP色调映射，允许实时提取字幕 开启硬件解码 VAAPI 设置完成后找个视频测试下转码即可，通过开启/关闭硬件解码情况下的不同CPU占用即可判断硬件解码是否生效。 关闭硬件解码，CPU占用率约70%，而且较为卡顿，转码帧率7.9fps 软解码 星球大战9：天行者崛起 开启硬件解码，CPU占用率约10%，转码帧率25fps，不过由于性能的问题，也很难说完全流畅 硬解码 星球大战9：天行者崛起 但是通过这样的对比，可以看到硬件解码大大降低了CPU占用，就可以明确硬件解码的配置是生效了的。但是具体表现还是受到硬件性能、数据读写速度方面的限制。 本文到此结束，后续有细节调整的话再看是否更新吧。 例如网页界面显示方块之类的... 参考 本文参考了以下文章和工具，一并列出。 PVE部署LXC运行docker LXC安装jellyfin并开启硬件转码_存储设备_什么值得买 showmount : 查看NFS共享目录 如何在Linux中挂载NFS共享 LXC安装JellyFin并轻松开启硬件编码 - TimZhong's Blog Hardware Acceleration ubuntu 镜像站使用帮助 清华大学开源软件镜像站 Tsinghua Open Source Mirror ivanhao/pvetools ","link":"https://ioby-one.github.com/post/install-jellyfin-on-PVE-with-LXC-and-enable-hardware-acceleration/"}]}